openapi: 3.0.3
info:
  title: Slack-Notion Integration Service API
  description: Internal API for managing Slack-Notion integration operations
  version: 1.0.0
  contact:
    name: Development Team
    email: dev@company.com

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://slack-notion-integration.company.com
    description: Production server

paths:
  /health:
    get:
      summary: Health check endpoint
      description: Returns service health status and external API connectivity
      tags: [Health]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /slack/commands:
    post:
      summary: Handle Slack slash commands
      description: Process incoming slash commands from Slack and create Notion pages
      tags: [Slack Integration]
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/SlackSlashCommand'
      responses:
        '200':
          description: Command processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SlackCommandResponse'
        '400':
          description: Invalid command format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /slack/events:
    post:
      summary: Handle Slack events
      description: Process Slack events for keyword monitoring and message aggregation
      tags: [Slack Integration]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SlackEvent'
      responses:
        '200':
          description: Event processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
        '400':
          description: Invalid event format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /messages:
    get:
      summary: List processed messages
      description: Retrieve processed Slack messages with filtering and pagination
      tags: [Messages]
      parameters:
        - name: channel_id
          in: query
          description: Filter by Slack channel ID
          schema:
            type: string
        - name: status
          in: query
          description: Filter by processing status
          schema:
            type: string
            enum: [pending, processed, failed, duplicate]
        - name: limit
          in: query
          description: Maximum number of results
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of results to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Messages retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageList'

  /messages/{messageId}:
    get:
      summary: Get message details
      description: Retrieve detailed information about a specific message
      tags: [Messages]
      parameters:
        - name: messageId
          in: path
          required: true
          description: Slack message ID
          schema:
            type: string
      responses:
        '200':
          description: Message details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SlackMessage'
        '404':
          description: Message not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /messages/{messageId}/reprocess:
    post:
      summary: Reprocess failed message
      description: Retry processing for a failed message
      tags: [Messages]
      parameters:
        - name: messageId
          in: path
          required: true
          description: Slack message ID
          schema:
            type: string
      responses:
        '200':
          description: Message reprocessing initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessingStatus'
        '404':
          description: Message not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /keywords:
    get:
      summary: List keyword rules
      description: Retrieve configured keyword monitoring rules
      tags: [Keywords]
      responses:
        '200':
          description: Keyword rules retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeywordRuleList'
    post:
      summary: Create keyword rule
      description: Create new keyword monitoring rule
      tags: [Keywords]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateKeywordRule'
      responses:
        '201':
          description: Keyword rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeywordRule'
        '400':
          description: Invalid rule configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /keywords/{ruleId}:
    get:
      summary: Get keyword rule
      description: Retrieve specific keyword rule details
      tags: [Keywords]
      parameters:
        - name: ruleId
          in: path
          required: true
          description: Keyword rule ID
          schema:
            type: string
      responses:
        '200':
          description: Keyword rule retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeywordRule'
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update keyword rule
      description: Update existing keyword rule configuration
      tags: [Keywords]
      parameters:
        - name: ruleId
          in: path
          required: true
          description: Keyword rule ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateKeywordRule'
      responses:
        '200':
          description: Keyword rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KeywordRule'
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete keyword rule
      description: Remove keyword rule and stop monitoring
      tags: [Keywords]
      parameters:
        - name: ruleId
          in: path
          required: true
          description: Keyword rule ID
          schema:
            type: string
      responses:
        '204':
          description: Keyword rule deleted
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /summaries:
    get:
      summary: List summary reports
      description: Retrieve generated summary reports with filtering
      tags: [Summaries]
      parameters:
        - name: report_type
          in: query
          description: Filter by report type
          schema:
            type: string
            enum: [keyword_aggregation, channel_summary, thread_summary]
        - name: start_date
          in: query
          description: Filter reports after this date
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          description: Filter reports before this date
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Summary reports retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryReportList'

  /summaries/thread/{threadId}:
    post:
      summary: Generate thread summary
      description: Create summary for specific Slack thread
      tags: [Summaries]
      parameters:
        - name: threadId
          in: path
          required: true
          description: Slack thread timestamp
          schema:
            type: string
      responses:
        '201':
          description: Thread summary generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryReport'
        '400':
          description: Invalid thread ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /duplicates:
    get:
      summary: List duplicate groups
      description: Retrieve detected duplicate message groups
      tags: [Duplicates]
      parameters:
        - name: status
          in: query
          description: Filter by group status
          schema:
            type: string
            enum: [active, merged, split, archived]
      responses:
        '200':
          description: Duplicate groups retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateGroupList'

  /duplicates/{groupId}/merge:
    post:
      summary: Merge duplicate group
      description: Consolidate duplicate messages into single Notion page
      tags: [Duplicates]
      parameters:
        - name: groupId
          in: path
          required: true
          description: Duplicate group ID
          schema:
            type: string
      responses:
        '200':
          description: Duplicate group merged
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateGroup'
        '404':
          description: Group not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /queue:
    get:
      summary: Get processing queue status
      description: Retrieve current processing queue information
      tags: [Queue]
      responses:
        '200':
          description: Queue status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStatus'

components:
  schemas:
    HealthStatus:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
        timestamp:
          type: string
          format: date-time
        services:
          type: object
          properties:
            slack_api:
              $ref: '#/components/schemas/ServiceHealth'
            notion_api:
              $ref: '#/components/schemas/ServiceHealth'
            database:
              $ref: '#/components/schemas/ServiceHealth'

    ServiceHealth:
      type: object
      properties:
        status:
          type: string
          enum: [up, down, degraded]
        response_time_ms:
          type: integer
        last_check:
          type: string
          format: date-time

    SlackSlashCommand:
      type: object
      properties:
        token:
          type: string
        team_id:
          type: string
        team_domain:
          type: string
        channel_id:
          type: string
        channel_name:
          type: string
        user_id:
          type: string
        user_name:
          type: string
        command:
          type: string
        text:
          type: string
        response_url:
          type: string
        trigger_id:
          type: string

    SlackCommandResponse:
      type: object
      properties:
        response_type:
          type: string
          enum: [ephemeral, in_channel]
        text:
          type: string
        attachments:
          type: array
          items:
            type: object

    SlackEvent:
      type: object
      properties:
        token:
          type: string
        team_id:
          type: string
        api_app_id:
          type: string
        event:
          type: object
        type:
          type: string
        event_id:
          type: string
        event_time:
          type: integer

    EventResponse:
      type: object
      properties:
        challenge:
          type: string
          description: For URL verification

    SlackMessage:
      type: object
      properties:
        id:
          type: string
        text:
          type: string
        formatted_text:
          type: string
        author_id:
          type: string
        author_name:
          type: string
        channel_id:
          type: string
        channel_name:
          type: string
        timestamp:
          type: string
          format: date-time
        thread_ts:
          type: string
          nullable: true
        thread_replies:
          type: array
          items:
            type: string
        attachments:
          type: array
          items:
            type: object
        reactions:
          type: array
          items:
            type: object
        permalink:
          type: string
        is_bot:
          type: boolean
        processing_status:
          type: string
          enum: [pending, processed, failed, duplicate]

    MessageList:
      type: object
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/SlackMessage'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    ProcessingStatus:
      type: object
      properties:
        id:
          type: string
        status:
          type: string
          enum: [queued, processing, completed, failed, retry]
        scheduled_at:
          type: string
          format: date-time
        retry_count:
          type: integer

    KeywordRule:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        keywords:
          type: array
          items:
            type: string
        channels:
          type: array
          items:
            type: string
        notion_database_id:
          type: string
        aggregation_schedule:
          type: string
        match_mode:
          type: string
          enum: [exact, contains, regex]
        case_sensitive:
          type: boolean
        is_active:
          type: boolean
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        last_triggered:
          type: string
          format: date-time
          nullable: true
        match_count:
          type: integer

    CreateKeywordRule:
      type: object
      required:
        - name
        - keywords
        - channels
        - notion_database_id
      properties:
        name:
          type: string
        keywords:
          type: array
          items:
            type: string
          minItems: 1
        channels:
          type: array
          items:
            type: string
          minItems: 1
        notion_database_id:
          type: string
        aggregation_schedule:
          type: string
          default: "0 9 * * *"
        match_mode:
          type: string
          enum: [exact, contains, regex]
          default: contains
        case_sensitive:
          type: boolean
          default: false

    UpdateKeywordRule:
      type: object
      properties:
        name:
          type: string
        keywords:
          type: array
          items:
            type: string
        channels:
          type: array
          items:
            type: string
        notion_database_id:
          type: string
        aggregation_schedule:
          type: string
        match_mode:
          type: string
          enum: [exact, contains, regex]
        case_sensitive:
          type: boolean
        is_active:
          type: boolean

    KeywordRuleList:
      type: object
      properties:
        rules:
          type: array
          items:
            $ref: '#/components/schemas/KeywordRule'
        total:
          type: integer

    SummaryReport:
      type: object
      properties:
        id:
          type: string
        report_type:
          type: string
          enum: [keyword_aggregation, channel_summary, thread_summary]
        time_period:
          type: string
        start_date:
          type: string
          format: date-time
        end_date:
          type: string
          format: date-time
        source_channels:
          type: array
          items:
            type: string
        source_keywords:
          type: array
          items:
            type: string
        message_count:
          type: integer
        summary_text:
          type: string
        key_topics:
          type: array
          items:
            type: string
        participants:
          type: array
          items:
            type: string
        action_items:
          type: array
          items:
            type: string
        notion_page_id:
          type: string
        generated_at:
          type: string
          format: date-time

    SummaryReportList:
      type: object
      properties:
        reports:
          type: array
          items:
            $ref: '#/components/schemas/SummaryReport'
        total:
          type: integer

    DuplicateGroup:
      type: object
      properties:
        id:
          type: string
        similarity_threshold:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
        primary_message_id:
          type: string
        duplicate_message_ids:
          type: array
          items:
            type: string
        consolidated_page_id:
          type: string
        detection_algorithm:
          type: string
          enum: [exact_hash, content_similarity, semantic_similarity]
        confidence_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
        created_at:
          type: string
          format: date-time
        last_updated:
          type: string
          format: date-time
        status:
          type: string
          enum: [active, merged, split, archived]

    DuplicateGroupList:
      type: object
      properties:
        groups:
          type: array
          items:
            $ref: '#/components/schemas/DuplicateGroup'
        total:
          type: integer

    QueueStatus:
      type: object
      properties:
        total_items:
          type: integer
        pending_items:
          type: integer
        processing_items:
          type: integer
        failed_items:
          type: integer
        queue_types:
          type: object
          properties:
            slack_commands:
              type: integer
            notion_creates:
              type: integer
            aggregation_jobs:
              type: integer
        average_processing_time_ms:
          type: integer
        last_processed:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string
        timestamp:
          type: string
          format: date-time

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

security:
  - ApiKeyAuth: []

tags:
  - name: Health
    description: Service health and monitoring
  - name: Slack Integration
    description: Slack API event handling
  - name: Messages
    description: Message processing and management
  - name: Keywords
    description: Keyword rule configuration
  - name: Summaries
    description: Summary report generation
  - name: Duplicates
    description: Duplicate message detection and management
  - name: Queue
    description: Processing queue monitoring